# Story 11.5: Role-based Collaboration Controls

## User Story

As a workspace administrator or team lead,
I want granular role-based permissions and collaboration controls to manage team access, govern collaborative activities, and ensure appropriate security boundaries,
So that I can maintain team security, control sensitive information access, and create appropriate collaboration governance for my organization.

## Story Context

**Existing System Integration:**
- Integrates with: Current Supabase Auth system, workspace membership from Story 11.2, existing RLS policies, user session management
- Technology: Supabase Row Level Security, PostgreSQL role-based access, existing authentication middleware, workspace member management
- Follows pattern: Current user permission patterns, database security policies, authentication state management, admin controls
- Touch points: Workspace member roles, conversation access control, prompt library permissions, collaboration session management

**Current System Context:**
- **Relevant existing functionality**: Basic user authentication, workspace member roles (admin/moderator/member), individual conversation access control, admin user management system
- **Technology stack**: Supabase Auth with RLS policies, PostgreSQL permissions, React Context authentication state, existing admin dashboard
- **Integration points**: Workspace membership system, conversation sharing mechanisms, prompt library access, analytics dashboard permissions
- **Existing patterns**: RLS policy enforcement, user role checking, permission-based UI rendering, secure API endpoint access

## Acceptance Criteria

**Functional Requirements:**

1. **Hierarchical Role System**
   - Workspace Owner: Full administrative control including workspace deletion and owner transfer
   - Workspace Admin: Full management capabilities except ownership transfer
   - Moderator: Content management and member supervision capabilities
   - Member: Standard collaboration access with configurable restrictions
   - Guest: Limited read-only access for external collaboration
   - Custom Roles: Ability to create custom roles with specific permission combinations

2. **Granular Permission Controls**
   - Conversation Permissions: Create, edit, delete, share conversations with role-based restrictions
   - Collaboration Permissions: Initiate real-time collaboration, join existing sessions, moderate collaborative editing
   - Prompt Library Permissions: Create, edit, approve, delete team prompts with workflow controls
   - Analytics Permissions: View team analytics, export data, configure tracking settings
   - Member Management: Invite users, modify roles, remove members based on hierarchical permissions

3. **Content Governance Features**
   - Conversation approval workflows for sensitive content or external sharing
   - Prompt review and approval system with designated reviewers
   - Content moderation tools including flagging and review queues
   - Audit trail for all governance actions and permission changes

4. **Access Control Enforcement**
   - Real-time permission checking during collaborative editing sessions
   - Dynamic UI adjustments based on user permissions and role capabilities
   - API endpoint security with role-based access validation
   - Session-level permission caching for optimal performance

5. **Collaboration Session Management**
   - Role-based collaboration initiation and invitation controls
   - Session moderation capabilities including participant management
   - Breakout session creation and management for complex team structures
   - Emergency session termination and conflict resolution tools

**Integration Requirements:**

6. **Workspace Integration Enhancement**
   - Extends workspace member roles from Story 11.2 with granular permissions
   - Integrates with workspace invitation system for role assignment
   - Workspace settings include role configuration and permission templates
   - Multi-workspace role inheritance for organization-wide governance

7. **Collaborative Feature Security**
   - Real-time collaboration from Story 11.1 respects role-based access controls
   - Prompt development from Story 11.3 includes approval workflows and role restrictions
   - Analytics access from Story 11.4 follows permission hierarchies
   - All collaborative features enforce role-based security boundaries

8. **Existing Auth System Extension**
   - Leverages current Supabase Auth infrastructure for user identification
   - Extends existing RLS policies with workspace and role-based rules
   - Integrates with current admin dashboard for role management interfaces
   - Maintains compatibility with individual user authentication patterns

**Quality Requirements:**

9. **Security & Compliance**
   - All permission checks are enforced at database level with RLS policies
   - Role changes require appropriate authorization and audit logging
   - Sensitive operations require additional confirmation or multi-factor authentication
   - Data access logs maintain compliance audit trails

10. **Performance & Usability**
    - Permission checks complete within 50ms for standard operations
    - Role-based UI rendering performs smoothly without noticeable delays
    - Bulk permission changes handle up to 100 members efficiently
    - Clear error messages and feedback for permission-denied operations

11. **Governance & Auditability**
    - Complete audit trail of all role changes and permission modifications
    - Governance policy enforcement with configurable workflow rules
    - Regular permission review and cleanup recommendations
    - Compliance reporting for organizational security requirements

## Technical Implementation Notes

**Enhanced Permission System:**
```sql
-- Extended workspace member roles with detailed permissions
CREATE TYPE workspace_permission AS ENUM (
    'conversations.create',
    'conversations.edit.own',
    'conversations.edit.all',
    'conversations.delete.own',
    'conversations.delete.all',
    'conversations.share.internal',
    'conversations.share.external',
    'collaboration.initiate',
    'collaboration.join',
    'collaboration.moderate',
    'prompts.create',
    'prompts.edit.own',
    'prompts.edit.all',
    'prompts.approve',
    'prompts.delete',
    'analytics.view',
    'analytics.export',
    'members.invite',
    'members.manage',
    'settings.manage'
);

-- Role permission mapping
CREATE TABLE workspace_role_permissions (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    workspace_id uuid REFERENCES workspaces(id) ON DELETE CASCADE,
    role_name text NOT NULL,
    permissions workspace_permission[] NOT NULL,
    is_default boolean DEFAULT false,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now()
);

-- User-specific permission overrides
CREATE TABLE workspace_member_permissions (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    workspace_id uuid REFERENCES workspaces(id) ON DELETE CASCADE,
    user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE,
    permission workspace_permission NOT NULL,
    granted boolean DEFAULT true, -- true = granted, false = explicitly denied
    granted_by uuid REFERENCES auth.users(id),
    expires_at timestamptz,
    created_at timestamptz DEFAULT now()
);

-- Governance workflows
CREATE TABLE governance_workflows (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    workspace_id uuid REFERENCES workspaces(id) ON DELETE CASCADE,
    workflow_type text NOT NULL, -- conversation_approval, prompt_review, member_invitation
    config jsonb NOT NULL,
    is_active boolean DEFAULT true,
    created_by uuid REFERENCES auth.users(id),
    created_at timestamptz DEFAULT now()
);

-- Approval requests
CREATE TABLE approval_requests (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    workspace_id uuid REFERENCES workspaces(id) ON DELETE CASCADE,
    workflow_id uuid REFERENCES governance_workflows(id),
    requested_by uuid REFERENCES auth.users(id),
    request_type text NOT NULL,
    request_data jsonb NOT NULL,
    status text DEFAULT 'pending', -- pending, approved, rejected, expired
    reviewed_by uuid REFERENCES auth.users(id),
    reviewed_at timestamptz,
    expires_at timestamptz,
    created_at timestamptz DEFAULT now()
);

-- Permission audit log
CREATE TABLE permission_audit_log (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    workspace_id uuid REFERENCES workspaces(id) ON DELETE CASCADE,
    user_id uuid REFERENCES auth.users(id),
    action text NOT NULL, -- role_change, permission_grant, permission_revoke
    target_user_id uuid REFERENCES auth.users(id),
    old_value jsonb,
    new_value jsonb,
    performed_by uuid REFERENCES auth.users(id),
    ip_address inet,
    user_agent text,
    created_at timestamptz DEFAULT now()
);
```

**Permission Checking Framework:**
```typescript
// Permission checking service
class PermissionService {
  async hasPermission(
    userId: string, 
    workspaceId: string, 
    permission: WorkspacePermission
  ): Promise<boolean> {
    // Check role-based permissions
    // Check individual overrides
    // Cache results for session
  }

  async requirePermission(
    userId: string, 
    workspaceId: string, 
    permission: WorkspacePermission
  ): Promise<void> {
    // Throw if permission denied
  }
}

// React hook for permission checking
export function usePermission(permission: WorkspacePermission) {
  // Return permission state and loading status
}
```

**Component Architecture:**
- **RoleManagementPanel**: Admin interface for managing workspace roles and permissions
- **PermissionMatrix**: Visual matrix for configuring role permissions
- **GovernanceWorkflowManager**: Configuration interface for approval workflows
- **ApprovalQueue**: Dashboard for managing pending approval requests
- **PermissionGuard**: React component for conditional rendering based on permissions
- **AuditLogViewer**: Interface for viewing and filtering permission audit trails

**Advanced RLS Policies:**
```sql
-- Dynamic permission checking function
CREATE OR REPLACE FUNCTION user_has_workspace_permission(
    user_id uuid,
    workspace_id uuid,
    required_permission workspace_permission
) RETURNS boolean AS $$
DECLARE
    user_role text;
    role_permissions workspace_permission[];
    explicit_grant boolean;
    explicit_deny boolean;
BEGIN
    -- Get user role in workspace
    SELECT role INTO user_role
    FROM workspace_members
    WHERE workspace_members.user_id = user_id 
    AND workspace_members.workspace_id = workspace_id
    AND status = 'active';

    -- Get role permissions
    SELECT permissions INTO role_permissions
    FROM workspace_role_permissions
    WHERE workspace_role_permissions.workspace_id = workspace_id
    AND role_name = user_role;

    -- Check for explicit user-level grants/denials
    SELECT granted INTO explicit_grant
    FROM workspace_member_permissions
    WHERE workspace_member_permissions.user_id = user_id
    AND workspace_member_permissions.workspace_id = workspace_id
    AND permission = required_permission
    AND granted = true
    AND (expires_at IS NULL OR expires_at > now());

    SELECT granted INTO explicit_deny
    FROM workspace_member_permissions
    WHERE workspace_member_permissions.user_id = user_id
    AND workspace_member_permissions.workspace_id = workspace_id
    AND permission = required_permission
    AND granted = false
    AND (expires_at IS NULL OR expires_at > now());

    -- Explicit deny overrides everything
    IF explicit_deny THEN
        RETURN false;
    END IF;

    -- Explicit grant overrides role permissions
    IF explicit_grant THEN
        RETURN true;
    END IF;

    -- Check role permissions
    RETURN required_permission = ANY(role_permissions);
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Apply to conversation access
CREATE POLICY conversation_role_access ON conversations
    FOR ALL USING (
        workspace_id IS NULL OR (
            workspace_id IS NOT NULL AND
            user_has_workspace_permission(auth.uid(), workspace_id, 'conversations.edit.all'::workspace_permission) OR
            (user_id = auth.uid() AND user_has_workspace_permission(auth.uid(), workspace_id, 'conversations.edit.own'::workspace_permission))
        )
    );
```

## Definition of Done

- [ ] Hierarchical role system provides flexible permission management for different team structures
- [ ] Granular permissions control access to all collaborative features and content
- [ ] Governance workflows enable approval processes for sensitive operations
- [ ] Real-time permission enforcement prevents unauthorized access during collaboration
- [ ] Role management interface allows administrators to configure team permissions easily
- [ ] All permission changes are logged with comprehensive audit trails
- [ ] Performance requirements met (50ms permission checks, smooth UI rendering)
- [ ] Security policies enforced at database level with robust RLS implementation
- [ ] Integration maintains compatibility with existing authentication and workspace systems
- [ ] Comprehensive testing covers permission scenarios, edge cases, and security boundaries
- [ ] Documentation includes governance best practices and role configuration guides

## Risk Assessment

**Primary Risk:** Complex permission system could introduce security vulnerabilities, performance bottlenecks, or user confusion if role hierarchies and permissions are not properly designed and implemented.

**Mitigation:**
- Implement comprehensive security testing including penetration testing for permission bypasses
- Add performance monitoring and caching for permission checks to prevent slowdowns
- Include extensive user testing for role management interfaces to ensure usability
- Provide clear documentation and training materials for administrators

**Rollback Plan:**
- Feature flag system allows reverting to simpler role model if complex permissions cause issues
- Database migration rollback procedures to restore previous permission structure
- Automatic fallback to workspace admin/member model if granular permissions fail
- Emergency admin override capabilities for critical access issues

## Dependencies

**Requires Completion:**
- Story 11.2 (Team Workspaces) - ✅ For workspace membership foundation
- Epic 7 (Enterprise Readiness) - ✅ For user management and authentication infrastructure

**Technical Dependencies:**
- Enhanced RLS policy framework for complex permission checking
- Permission caching system for optimal performance
- Audit logging infrastructure for compliance requirements
- Role management UI components for administrative interfaces

**Integration Dependencies:**
- All collaborative features require integration with permission checking system
- Existing admin dashboard needs role management interface integration
- Current authentication middleware requires permission checking enhancement

---

*Story created for Epic 11: Collaborative Intelligence*
*Estimated Complexity: High - Requires 3-4 development cycles*
*Priority: High - Critical for enterprise security and governance*