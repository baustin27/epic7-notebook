# Story 6.4: Advanced Model Settings - Brownfield Addition

## User Story

As a user,
I want to control advanced model parameters like temperature, max tokens, and system prompts,
So that I can fine-tune AI responses to match my specific use case and workflow preferences.

## Story Context

**Existing System Integration:**
- Integrates with: OpenRouter API integration, model selector, user settings, conversation system
- Technology: React components, OpenRouter API parameters, user_settings table extensions
- Follows pattern: Existing settings modals and user preferences patterns
- Touch points: ModelSelector component, openrouter.ts API calls, user settings management

## Acceptance Criteria

**Functional Requirements:**
1. Add advanced settings button/icon in the model selector area
2. Create advanced model settings modal with parameter controls:
   - Temperature slider (0.0-1.0) with explanatory labels
   - Max tokens input (100-4000) with model context awareness
   - System prompt textarea for custom instructions
   - Top-p nucleus sampling slider (0.0-1.0)
   - Presence penalty slider (-2.0-2.0)
   - Frequency penalty slider (-2.0-2.0)
3. Save user preferences per model (different settings per model)
4. Apply settings to API calls automatically
5. Provide preset templates (Creative, Balanced, Precise, Custom)
6. Reset to defaults functionality

**Integration Requirements:**
7. Existing model selection functionality continues to work unchanged
8. New advanced settings follow existing modal and settings patterns
9. Integration with user_settings table maintains backward compatibility
10. API parameter passing integrates seamlessly with current openrouter.ts

**Quality Requirements:**
11. Settings are persisted across browser sessions and devices
12. Parameter validation prevents invalid API calls
13. Settings load efficiently without impacting model selector performance
14. Clear explanations for each parameter with tooltips

## Technical Notes

- **Integration Approach**: Extend user_settings.preferences with model-specific advanced settings, modify openrouter.ts to use dynamic parameters
- **Existing Pattern Reference**: Follow existing settings modal patterns and user preferences structure
- **Key Constraints**: Must validate OpenRouter API parameter limits, maintain performance, handle model-specific limitations

## Definition of Done

- [ ] Advanced settings button added to model selector area
- [ ] Comprehensive model settings modal implemented with all parameters
- [ ] Parameter controls with proper validation and ranges
- [ ] Save user preferences per model functionality working
- [ ] Preset templates implemented and functional
- [ ] Settings apply to API calls automatically
- [ ] Reset to defaults functionality working
- [ ] Existing model selection functionality regression tested
- [ ] Settings persist across sessions properly
- [ ] Code follows existing patterns and standards
- [ ] Tests pass (existing and new)
- [ ] Parameter tooltips and help text implemented

## Risk and Compatibility Check

**Minimal Risk Assessment:**
- **Primary Risk**: Invalid parameter combinations causing API failures, performance impact on settings load
- **Mitigation**: Parameter validation before API calls, async settings loading, fallback to defaults on errors
- **Rollback**: Advanced settings can be disabled, model selector falls back to default parameters

**Compatibility Verification:**
- [ ] No breaking changes to existing model selection APIs
- [ ] Database changes are additive to user_settings.preferences only
- [ ] UI changes follow existing design patterns consistently
- [ ] Performance impact is minimal with efficient preference loading

---

*Created by Product Manager (pm) Agent*  
*Date: 2025-01-27*