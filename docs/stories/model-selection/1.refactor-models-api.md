# Story 1: Refactor Models API to Use Provider Factory

## Status
Ready for QA review

## Story
**As a** backend developer,  
**I want** the `/api/models` endpoint to dynamically fetch models from all configured providers using the provider factory,  
**so that** the system supports all available providers without hardcoded logic, ensuring scalability and completeness of model options.

## Acceptance Criteria
1. The `/api/models/route.ts` no longer contains hardcoded fetches for specific providers (e.g., remove direct OpenAI and OpenRouter API calls).
2. The endpoint calls `providerFactory.getAvailableModels()` to retrieve models from all configured providers (OpenAI, OpenRouter, Anthropic, Google, xAI).
3. Response includes models with id, name, provider, and additional metadata like pricing and context_length where available.
4. If no providers are configured, returns fallback default models (e.g., free OpenRouter models).
5. Error handling: Logs warnings for failed provider fetches but continues with successful ones.
6. Integration test verifies response structure and includes models from at least two providers when keys are set.
7. Performance: Endpoint responds within 2 seconds under normal conditions.
8. Backward compatibility: Existing ModelSelector continues to receive flat list of models.

## Tasks / Subtasks
- [ ] Update `/api/models/route.ts` to import and use `providerFactory.getAvailableModels()`
  - [ ] Remove hardcoded OpenAI and OpenRouter fetch logic
  - [ ] Map factory models to response format { id, name, provider }
  - [ ] Add fallback if factory returns empty array
- [ ] Enhance model data with additional fields from provider clients (pricing, context_length)
- [ ] Add logging for fetched models per provider
- [ ] Write unit test for new endpoint logic
- [ ] Write integration test simulating multiple provider keys

## Dev Notes
Relevant Source Tree:
- lib/providers/factory.ts: Use getAvailableModels method
- types/providers.ts: Ensure response aligns with ProviderModel interface

Testing Standards:
- Test file location: apps/web/__tests__/api/models.test.ts
- Test standards: Use Jest for unit/integration tests
- Testing frameworks: Jest with supertest for API testing
- Specific requirements: Mock provider clients to avoid real API calls during tests

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-10 | 1.0 | Initial story creation | Product Owner |

## Dev Agent Record
### Agent Model Used
To be filled by dev agent

### Debug Log References
To be filled by dev agent

### Completion Notes List
To be filled by dev agent

### File List
To be filled by dev agent

## QA Results
To be filled by QA agent